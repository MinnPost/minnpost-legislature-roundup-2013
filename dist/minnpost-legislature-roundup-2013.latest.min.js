/*! minnpost-legislature-roundup-2013 - v0.0.1 - 2013-05-29
* https://github.com/MinnPost/minnpost-legislature-roundup-2013
* Copyright (c) 2013 ; Licensed MIT */

var mpApp=mpApp||{};mpApp["minnpost-legislature-roundup-2013"]=mpApp["minnpost-legislature-roundup-2013"]||{},_.mixin({formatCurrency:function(t){var e=/(\d+)(\d{3})/;for(split=(""+t.toFixed(2)).split(".");e.test(split[0]);)split[0]=split[0].replace(e,"$1,$2");return"$"+split[0]+"."+split[1]},formatPercentage:function(t){return""+(100*t).toFixed(1)+"%"}}),function(t,e){t.defaultOptions={dataPath:"./"},t.templates=t.templates||{},t.getTemplate=function(n,a,i){var s="js/templates/"+n+".html";i=i||t,_.isUndefined(t.templates[s])?e.ajax({url:s,method:"GET",async:!1,contentType:"text",success:function(e){t.templates[s]=_.template(e),a.apply(i,[t.templates[s]])}}):a.apply(i,[t.templates[s]])},t.data=t.data||{},t.getData=function(n){var a="http://mp-jsonproxy.herokuapp.com/proxy?callback=?&url=",i=!1,s=[];return n=_.isArray(n)?n:[n],t.options&&0===t.options.dataPath.indexOf("http")&&(i=!0),_.each(n,function(n){var l;l=i?e.jsonp({url:a+encodeURI(t.options.dataPath+n+".json")}):e.getJSON(t.options.dataPath+n+".json"),s.push(l)}),e.when.apply(e,s)}}(mpApp["minnpost-legislature-roundup-2013"],jQuery),this.mpApp=this.mpApp||{},this.mpApp["minnpost-legislature-roundup-2013"]=this.mpApp["minnpost-legislature-roundup-2013"]||{},this.mpApp["minnpost-legislature-roundup-2013"].templates=this.mpApp["minnpost-legislature-roundup-2013"].templates||{},this.mpApp["minnpost-legislature-roundup-2013"].templates["js/templates/template-bill-list.html"]=function(obj){obj||(obj={});var __t,__p="";with(_.escape,Array.prototype.join,obj)__p+='\n<h4>Bills</h4>\n<div class="bills-list">\n  <ul>\n    ',_.each(bills,function(t){__p+='\n      <li><a data-id="'+(null==(__t=t.cid)?"":__t)+'" class="show-bill" href="#show-bill"><i class="bs-icon bs-icon-'+(null==(__t=t.get("bill_status"))?"":__t)+'"></i> '+(null==(__t=t.get("bill"))?"":__t)+"</a></li>\n    "}),__p+="\n  </ul>\n</div>";return __p},this.mpApp["minnpost-legislature-roundup-2013"].templates["js/templates/template-bill.html"]=function(obj){obj||(obj={});var __t,__p="";with(_.escape,Array.prototype.join,obj)__p+='\n<div class="bill-details-wrapper">\n  <div class="bill-status">'+(null==(__t=bill.get("bill_status"))?"":__t)+' <i class="bs-icon bs-icon-'+(null==(__t=bill.get("bill_status"))?"":__t)+'"></i></div>\n  <h4 class="bill-title">'+(null==(__t=bill.get("bill"))?"":__t)+'</h4>\n  <p class="bill-description">\n    <span class="bill-title">'+(null==(__t=bill.get("title"))?"":__t),"."!==bill.get("title").slice(-1)&&(__p+="."),__p+='</span>\n    <br />\n    <em><a target="_blank" href="'+(null==(__t=bill.get("billurl"))?"":__t)+'">View bill status and details.</a></em>\n    ',bill.get("notes")&&(__p+='\n      <em><span class="bill-notes">'+(null==(__t=bill.get("notes"))?"":__t)+"</span></em>\n    "),__p+="\n  </p>\n  \n  \n  ",void 0===bill.get("start_date")||0/0==bill.getDays()&&"NaN"==bill.getDays()||(__p+='\n    <div class="bill-timeline">\n      ',__p+="signed"==bill.get("bill_status")?'\n        <p>This bill took about <span class="timeline-days">'+(null==(__t=bill.getDays())?"":__t)+" days</span> to become law.</p>\n      ":"vetoed"==bill.get("bill_status")?'\n        <p>This bill was considered for at least <span class="timeline-days">'+(null==(__t=bill.getDays())?"":__t)+" days</span>.</p>\n      ":'\n        <p>This bill has been considered for at least <span class="timeline-days">'+(null==(__t=bill.getDays())?"":__t)+" days</span>.</p>\n      ",__p+='\n      <div class="session-start">\n        <span>Jan '+(null==(__t=bill.sessionBegin().getDate())?"":__t)+'</span>\n      </div>\n      <div class="bill-timeline-container">\n        <div style="width: '+(null==(__t=100*bill.getIntervalPercentage())?"":__t)+"%; margin-left: "+(null==(__t=100*bill.getStartPercentage())?"":__t)+'%;" class="bill-timeline-interval">\n        </div>\n      </div>\n      <div class="session-end">\n        <span>May '+(null==(__t=bill.sessionEnd().getDate())?"":__t)+'</span>\n      </div>\n      <br class="clear" />\n    </div>\n  '),__p+='\n  \n  \n  <div class="bill-house">\n    ',bill.get("house_ayes")!==void 0&&(__p+='\n      <div class="bill-house-votes bill-votes">\n        <div>\n          ',__p+=0>bill.get("house_ayes")?"\n            &nbsp;\n          ":"\n            "+(null==(__t=bill.get("house_ayes"))?"":__t)+"-"+(null==(__t=bill.get("house_nays"))?"":__t)+"\n          ",__p+="\n        </div>\n      </div>\n    "),__p+='\n    \n    <div class="bill-house-sponsors">\n      ',_.isEmpty(bill.get("house_sponsors"))||(__p+="\n        <h6>House Sponsors</h6>\n        <ul>\n          ",_.each(bill.get("house_sponsors"),function(t){__p+="\n            ",t[3]?(__p+='\n              <li>\n                <a target="_blank" href="'+(null==(__t=t[3])?"":__t)+'">'+(null==(__t=t[0])?"":__t)+"</a>\n                ",t[1]&&(__p+="\n                  ("+(null==(__t=t[1].charAt(0))?"":__t)+")\n                "),__p+="\n              </li>\n            "):__p+="\n              <li>"+(null==(__t=t[0])?"":__t)+"</li>\n            ",__p+="\n          "}),__p+="\n        </ul>\n      "),__p+='\n    </div>\n  </div>\n\n  <div class="bill-senate">\n    ',bill.get("senate_ayes")!==void 0&&(__p+='\n      <div class="bill-senate-votes bill-votes">\n        <div>\n          ',__p+=0>bill.get("senate_ayes")?"\n            &nbsp;\n          ":"\n            "+(null==(__t=bill.get("senate_ayes"))?"":__t)+"-"+(null==(__t=bill.get("senate_nays"))?"":__t)+"\n          ",__p+="\n        </div>\n      </div>\n    "),__p+='\n    \n    <div class="bill-senate-sponsors">\n      ',_.isEmpty(bill.get("senate_sponsors"))||(__p+="\n        <h6>Senate Sponsors</h6>\n        <ul>\n          ",_.each(bill.get("senate_sponsors"),function(t){__p+="\n            ",t[3]?(__p+='\n              <li>\n                <a target="_blank" href="'+(null==(__t=t[3])?"":__t)+'">'+(null==(__t=t[0])?"":__t)+"</a>\n                ",t[1]&&(__p+="\n                  ("+(null==(__t=t[1].charAt(0))?"":__t)+")\n                "),__p+="\n              </li>\n            "):__p+="\n              <li>"+(null==(__t=t[0])?"":__t)+"</li>\n            ",__p+="\n          "}),__p+="\n        </ul>\n      "),__p+='\n    </div>\n  </div>\n  <br class="clear" />\n  \n  ',_.isEmpty(bill.get("categories"))||(__p+='\n    <div class="bill-categories">\n      Categories: \n      <ul>\n        ',_.each(bill.get("categories"),function(t,e,n){__p+='\n          <li>\n            <a href="#'+(null==(__t=t)?"":__t)+'" data-category="'+(null==(__t=t)?"":__t)+'">'+(null==(__t=t)?"":__t)+"</a>",n.length-1>e&&(__p+=","),__p+="\n          </li>\n        "}),__p+="\n      </ul>\n    "),__p+="\n  </div>\n</div>";return __p},this.mpApp["minnpost-legislature-roundup-2013"].templates["js/templates/template-category.html"]=function(obj){obj||(obj={});var __t,__p="";with(_.escape,Array.prototype.join,obj)__p+='\n<a class="all-categories" href="#all-categories"><i class="bs-icon bs-icon-white bs-icon-circle-arrow-left"></i> back</a>\n<h3>\n  ',"undefined"!=typeof image_url&&(__p+='\n    <img class="category-image" src="'+(null==(__t=image_url)?"":__t)+'" /> \n  '),__p+="\n  ","undefined"!=typeof sponsor&&sponsor[2]!==void 0&&(__p+='\n    <img class="category-image" src="'+(null==(__t=sponsor[2])?"":__t)+'" /> \n  '),__p+="\n  "+(null==(__t=category)?"":__t)+"\n  ","undefined"!=typeof sponsor&&sponsor[1]!==void 0&&(__p+="\n    ("+(null==(__t=sponsor[1].charAt(0))?"":__t)+")\n  "),__p+="\n</h3>";return __p},function(t,e){function n(t,n){function l(t,n,a,i,s){return function(){var l=t.set();l.push(a).push(i).push(s).mouseover(function(){a.attr("opacity","1.0"),i.attr("opacity","1.0")}).mouseout(function(){a.attr("opacity","0.8"),i.attr("opacity","0.6")}).click(function(){n!==undefined&&(n.filterCategory(this.data("name").replace("\n","")),e("#bubble-chooser").slideUp("fast"),e("#category-details").slideDown("fast"))})}}var o=650,r=975,c=6,p=60,_=150,u=-50,d=165,h=["156DAC","1571A6","1575A0","15799A","157D94","15828E","158688","158A82","158E7D","159277","159771","159B6B","159F65","15A35F","15A759","15AC54"],g=[],m={Vetoed:"323232",Controversial:"E31C2D"},b={Vetoed:-1,Controversial:-2},f=1;for(var v in t)f=t[v].length>f?t[v].length:f,g.push({name:v,bills:t[v]});g=g.sort(function(t,e){return b[t.name]!==undefined?0-b[t.name]:b[e.name]!==undefined?b[e.name]:e.bills.length-t.bills.length});var y=Raphael(document.getElementById("bubble-chart"),r,o);for(var w in g){var j=g[w].bills.length/f,A=p*p*Math.PI,C=p*c*Math.PI,D=j*(A-C)+C,B=Math.sqrt(D/Math.PI),E=h[Math.floor(Math.random()*h.length)];m[g[w].name]!==undefined&&(E=m[g[w].name]),u+=150,u+B>=r&&(u=100,d+=_);var k=y.circle(Math.random()*(r-B),Math.random()*(o-B),0).data("name",g[w].name).data("spreadX",u).data("spreadY",d-B).data("radius",B).attr("fill",Raphael.rgb(a(E,"R"),a(E,"G"),a(E,"B"))).attr("opacity","0.7").attr("stroke-width",.5).attr("cursor","pointer"),I=Raphael.animation({r:B},1e3,"easeIn");k.animate(I.delay(1e3*Math.random()));var T=y.text(k.attrs.cx,k.attrs.cy).attr("font-size",12).attr("fill","#444").attr("cursor","pointer").data("spreadX",u).data("spreadY",d+20).data("name",g[w].name);T=s(g[w].name,T);var x=n.getCatIcon(g[w].name);x=y.image("https://s3.amazonaws.com/data.minnpost/projects/mn-legislature-roundup-2012/icons/"+x+".png",Math.random()*(r-B),Math.random()*(o-B),.9*B,.9*B).attr("opacity","0.1").attr("cursor","pointer").data("spreadX",u-.5*B+1).data("spreadY",d-1.5*B+1).data("name",g[w].name);var M=Raphael.animation({opacity:"0.6"},1e3,"easeIn");x.animate(M.delay(1e3*Math.random()));var P=l(y,n,k,x,T);P()}i(y)}function a(t,e){switch(t="#"==t.charAt(0)?t.substring(1,7):t,e){case"R":return parseInt(t.substring(0,2),16);case"G":return parseInt(t.substring(2,4),16);case"B":return parseInt(t.substring(4,6),16)}}function i(t){t.forEach(function(t){var e;"circle"===t.type?(e=Raphael.animation({cx:t.data("spreadX"),cy:t.data("spreadY")},1e3,"backOut"),t.animate(e.delay(1e3*Math.random()))):("text"===t.type||"image"===t.type)&&(e=Raphael.animation({x:t.data("spreadX"),y:t.data("spreadY")},1e3,"backOut"),t.animate(e.delay(1e3*Math.random())))})}function s(t,e){for(var n=140,a=t.split(" "),i="",s=0;a.length>s;s++)e.attr("text",i+" "+a[s]),i+=e.getBBox(!0).width>n?"\n"+a[s]:" "+a[s];return e.attr("text",i.substring(1))}var l=Backbone.Model.extend({sessionBegin:function(){return t.options.sessionBegin},sessionEnd:function(){return t.options.sessionEnd},convertDate:function(t){var e=t.replace(/( [0-9]{2}:[0-9]{2}:[0-9]{2}$)/,"").split("-");return _.isArray(e)&&3==e.length?new Date(e[0],e[1]-1,e[2]):new Date},getDays:function(){var t=this.convertDate(this.get("start_date")),e=this.convertDate(this.get("end_date")),n=432e5;return Math.ceil((e.getTime()+1-t.getTime())/n)},getIntervalPercentage:function(){var t,e=432e5,n=this.sessionBegin(),a=this.sessionEnd(),i=Math.ceil((a.getTime()+1-n.getTime())/e),s=3>this.getDays()?3:this.getDays();return t=this.getStartPercentage()+s/i>=1?1-this.getStartPercentage():s>i?1:s/i},getStartPercentage:function(){var t=432e5,e=this.sessionBegin(),n=this.sessionEnd(),a=this.convertDate(this.get("start_date")),i=Math.ceil((a.getTime()+1-e.getTime())/t),s=Math.ceil((n.getTime()+1-e.getTime())/t);return a.getTime()<e.getTime()?0:i/s},getSponsorData:function(t,e){var n="representative"==e?"house_sponsors":"senate_sponsors",a=this.get(n);if(_.isArray(a))for(var i in a)if(a[i][0]==t)return a[i]}}),o=Backbone.Collection.extend({model:l,filterCategory:function(t){return this.filter(function(e){if(_.isArray(e.get("categories"))){var n=_.filter(e.get("categories"),function(e){return e==t});return!_.isEmpty(n)}return!1})},filterAuthor:function(t,e){var n="representative"==e?"house_sponsors":"senate_sponsors";return _.isArray(t)||(t=[t]),this.filter(function(e){if(_.isArray(e.get(n))){var a=_.filter(e.get(n),function(e){return-1===_.indexOf(t,e[0])?!1:!0});return!_.isEmpty(a)}return!1})},comparator:function(t){return"pending"==t.get("bill_status")?"zzz":t.get("bill_status")}}),r=Backbone.View.extend({initialize:function(t){_.bindAll(this,"render"),this.model=t.model||new l},render:function(){return t.getTemplate("template-bill",function(t){e(this.el).html(t({bill:this.model}));var n=e(".bill-details-wrapper").height(),a=e("#bills-list-container").height();a>n&&e(".bill-details-wrapper").height(a)},this),this}}),c=Backbone.View.extend({categoryContainer:e("#bill-category-container"),listContainer:e("#bills-list-container"),events:{"click .show-bill":"showBill","submit form#address-chooser-form":"showByAddress"},initialize:function(t){_.bindAll(this,"render","showBill","showFirstBill","activateBill","showByAddress","filterCategory"),this.collection=t.collection||new o,this.fullCollection=new o(this.collection.models),this.billView=new r({el:e("#bill-detail-container")})},render:function(){return t.getTemplate("template-bill-list",function(t){this.listContainer.html(t({bills:this.collection.models}));var n=e(".bills-list ul li").size();n>16&&e(".bills-list").addClass("is-scrolling")},this),this},showBill:function(t){t.preventDefault();var n=e(t.currentTarget);return this.billView.model=this.collection.get(n.attr("data-id")),this.activateBill(n),this.billView.render(),this.activateCategoryLinks(),this},showFirstBill:function(){return this.billView.model=this.collection.at(0),this.activateBill(e('[data-id="'+this.billView.model.cid+'"]')),this.billView.render(),this.activateCategoryLinks(),this},activateCategoryLinks:function(){var t=this;return e(".bill-categories ul a").click(function(n){n.preventDefault(),t.filterCategory(e(this).attr("data-category"))}),t},activateBill:function(t){return e(".show-bill").removeClass("active"),t.addClass("active"),this},showCategory:function(e){return t.getTemplate("template-category",function(t){this.categoryContainer.html(t(e))},this),this},showError:function(t){e('<div class="address-error">'+t+"</div>").hide().prependTo("#address-chooser-form").fadeIn()},removeErrors:function(){e("#address-chooser-form .address-error").fadeOut("fast")},showByAddress:function(n){n.preventDefault();var a,i=this;e(n.currentTarget);var s=e('input:radio[name="author_type"]:checked').val(),l=e("input#address-chooser-address").val(),o=[43.499356,-97.239209,49.384358,-89.489226];this.removeErrors(),a="http://www.mapquestapi.com/geocoding/v1/address?key="+t.options.mapQuestKey+"&outFormat=json&callback=?&countrycodes=us&maxResults=1&location="+encodeURI(l),e.getJSON(a,function(t){var n;try{n=t.results[0].locations[0].latLng}catch(a){return i.showError("We were unable turn your search terms, "+l+", into a geographical location.  Please be more specific, such as including ZIP code."),undefined}if(n.lat<o[0]||n.lat>o[2]||n.lng<o[1]||n.lng>o[3])i.showError("Sorry, but what you are looking for is outside of Minnesota.");else{var r="49c5c72c157d4b37892ddb52c63d06be",c="http://openstates.org/api/v1/legislators/geo/?long="+encodeURI(n.lng)+"&lat="+encodeURI(n.lat)+"&apikey="+encodeURI(r)+"&callback=?";e.getJSON(c,function(t){var n,a=[],l="representative"==s?"lower":"upper";for(n in t)t[n].active&&"state"==t[n].level&&t[n].chamber==l&&a.push(t[n].full_name);if(_.isEmpty(a))i.showError("We could not find a representative for that address.");else{var o=a[a.length-1],r=i.filterAuthor(o,s,!0);_.isEmpty(r)?i.showError("There were no bills found that were sponsored by your legislator(s): <em>"+o+"</em>.  This could be an issue with the data quality and may not accurately reflect the activities of these legislator(s)."):(e("#address-chooser").slideUp("fast"),e("#category-details").slideDown("fast"))}})}})},filterAuthor:function(t,e){var n=this.fullCollection.filterAuthor(t,e);return _.isEmpty(n)||(this.collection.reset(n),this.showCategory({category:t,sponsor:this.collection.at(0).getSponsorData(t,e)}),this.render(),this.showFirstBill()),n},filterCategory:function(t){var e=this.fullCollection.filterCategory(t);if(_.isEmpty(e));else{this.collection.reset(e);var n="https://s3.amazonaws.com/data.minnpost/projects/mn-legislature-roundup-2012/icons/"+this.getCatIcon(t)+".png";this.showCategory({category:t,image_url:n}),this.render(),this.showFirstBill()}},getCatIcon:function(t){return icons={Government:"noun_project_1761","Energy and Technology":"noun_project_2075","Housing and Property":"noun_project_1439","Campaign Finance and Election Issues":"noun_project_287","Reproductive Issues":"noun_project_626","Environment and Recreation":"noun_project_479","Health and Science":"noun_project_1868",Military:"noun_project_1697","Welfare and poverty":"noun_project_620","Budget, Spending and Taxes":"noun_project_925",Insurance:"noun_project_1675","Business and Economy":"noun_project_1640",Education:"noun_project_1051",Immigration:"noun_project_31","Agriculture and Food":"noun_project_741","Arts and Humanities":"noun_project_1554",Guns:"noun_project_138","Gambling and Gaming":"noun_project_1740","Crime and Drugs":"noun_project_2039","Social Issues":"noun_project_288",Vetoed:"noun_project_558",Controversial:"noun_project_1635",Legal:"noun_project_1004",Transportation:"noun_project_97"},icons[t]!==undefined?icons[t]:""}});e('<span class="loading-temp">Loading...</span>').hide().prependTo(e("#application-nav").parent()).fadeIn(),billsProcess=function(a){var i,s={};for(i in a){var r;if(_.isArray(a[i].categories))for(r in a[i].categories)s[a[i].categories[r]]=s[a[i].categories[r]]||[],s[a[i].categories[r]].push(i)}var p=new o;for(i in a)a[i].bill=i,p.add(new l(a[i]));var u=new c({el:t.options.el,collection:p});e(".loading-temp").fadeOut(),e("#application-nav, #tab-container").show(),n(s,u),e(t.options.el).on("click",".all-categories",function(t){t.preventDefault(),e(".by-category").hasClass("tab-active")?e("#bubble-chooser").slideDown("fast"):e("#address-chooser").slideDown("fast"),e("#category-details").slideUp("fast")}),e(".by-category").click(function(t){t.preventDefault(),e(".by-category").hasClass("tab-active")||(e("#address-chooser").fadeOut("fast"),e("#application-nav li, #application-nav a").toggleClass("tab-active")),e("#bubble-chooser").fadeIn("fast"),e("#category-details").hide()}),e(".by-address").click(function(t){t.preventDefault(),e(".by-address").hasClass("tab-active")||(e("#bubble-chooser").fadeOut("fast"),e("#application-nav li, #application-nav a").toggleClass("tab-active")),e("#address-chooser").fadeIn("fast"),e("#category-details").hide()});var d="Enter your address";e("#address-chooser-address").val(d).addClass("showing-label").focus(function(){e(this).val()==d&&e(this).val("").removeClass("showing-label")}).blur(function(){(""===e(this).val()||e(this).val()==d)&&e(this).val(d).addClass("showing-label")})},t.start=function(){t.getData("data/bills").done(function(e){t.data.bills=e,billsProcess(e)})}}(mpApp["minnpost-legislature-roundup-2013"],jQuery);