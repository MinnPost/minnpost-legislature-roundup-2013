/*! minnpost-legislature-roundup-2013 - v0.0.1 - 2013-05-29
* https://github.com/MinnPost/minnpost-legislature-roundup-2013
* Copyright (c) 2013 ; Licensed MIT */

var mpApp=mpApp||{};mpApp["minnpost-legislature-roundup-2013"]=mpApp["minnpost-legislature-roundup-2013"]||{},_.mixin({formatCurrency:function(t){var e=/(\d+)(\d{3})/;for(split=(""+t.toFixed(2)).split(".");e.test(split[0]);)split[0]=split[0].replace(e,"$1,$2");return"$"+split[0]+"."+split[1]},formatPercentage:function(t){return""+(100*t).toFixed(1)+"%"}}),function(t,e){t.defaultOptions={dataPath:"./"},t.templates=t.templates||{},t.getTemplate=function(n,a,i){var s="js/templates/"+n+".html";i=i||t,_.isUndefined(t.templates[s])?e.ajax({url:s,method:"GET",async:!1,contentType:"text",success:function(e){t.templates[s]=_.template(e),a.apply(i,[t.templates[s]])}}):a.apply(i,[t.templates[s]])},t.data=t.data||{},t.getData=function(n){var a="http://mp-jsonproxy.herokuapp.com/proxy?callback=?&url=",i=!1,s=[];return n=_.isArray(n)?n:[n],t.options&&0===t.options.dataPath.indexOf("http")&&(i=!0),_.each(n,function(n){var l;l=i?e.jsonp({url:a+encodeURI(t.options.dataPath+n+".json")}):e.getJSON(t.options.dataPath+n+".json"),s.push(l)}),e.when.apply(e,s)}}(mpApp["minnpost-legislature-roundup-2013"],jQuery),this.mpApp=this.mpApp||{},this.mpApp["minnpost-legislature-roundup-2013"]=this.mpApp["minnpost-legislature-roundup-2013"]||{},this.mpApp["minnpost-legislature-roundup-2013"].templates=this.mpApp["minnpost-legislature-roundup-2013"].templates||{},this.mpApp["minnpost-legislature-roundup-2013"].templates["js/templates/template-bill-list.html"]=function(obj){obj||(obj={});var __t,__p="";with(_.escape,Array.prototype.join,obj)__p+='\n<h4>Bills</h4>\n<div class="bills-list">\n  <ul>\n    ',_.each(bills,function(t){__p+='\n      <li><a data-id="'+(null==(__t=t.cid)?"":__t)+'" class="show-bill" href="#show-bill"><i class="bs-icon bs-icon-'+(null==(__t=t.get("bill_status"))?"":__t)+'"></i> '+(null==(__t=t.get("bill"))?"":__t)+"</a></li>\n    "}),__p+="\n  </ul>\n</div>";return __p},this.mpApp["minnpost-legislature-roundup-2013"].templates["js/templates/template-bill.html"]=function(obj){obj||(obj={});var __t,__p="";with(_.escape,Array.prototype.join,obj)__p+='\n<div class="bill-details-wrapper">\n  <div class="bill-status">'+(null==(__t=bill.get("bill_status"))?"":__t)+' <i class="bs-icon bs-icon-'+(null==(__t=bill.get("bill_status"))?"":__t)+'"></i></div>\n  <h4 class="bill-title">'+(null==(__t=bill.get("bill"))?"":__t)+'</h4>\n  <p class="bill-description"><span class="bill-title">'+(null==(__t=bill.get("title"))?"":__t)+'</span> [<a target="_blank" href="'+(null==(__t=bill.get("billurl"))?"":__t)+'">view bill status and details</a>]</p>\n  \n  \n  ',void 0===bill.get("start_date")||0/0==bill.getDays()&&"NaN"==bill.getDays()||(__p+='\n    <div class="bill-timeline">\n      ',__p+="signed"==bill.get("bill_status")?'\n        <p>This bill took about <span class="timeline-days">'+(null==(__t=bill.getDays())?"":__t)+" days</span> to become law.</p>\n      ":"vetoed"==bill.get("bill_status")?'\n        <p>This bill was considered for at least <span class="timeline-days">'+(null==(__t=bill.getDays())?"":__t)+" days</span>.</p>\n      ":'\n        <p>This bill has been considered for at least <span class="timeline-days">'+(null==(__t=bill.getDays())?"":__t)+" days</span>.</p>\n      ",__p+='\n      <div class="session-start">\n        <span>Jan 24</span>\n      </div>\n      <div class="bill-timeline-container">\n        <div style="width: '+(null==(__t=100*bill.getIntervalPercentage())?"":__t)+"%; margin-left: "+(null==(__t=100*bill.getStartPercentage())?"":__t)+'%;" class="bill-timeline-interval">\n        </div>\n      </div>\n      <div class="session-end">\n        <span>May 10</span>\n      </div>\n      <br class="clear" />\n    </div>\n  '),__p+='\n  \n  \n  <div class="bill-house">\n    ',bill.get("house_ayes")!==void 0&&(__p+='\n      <div class="bill-house-votes bill-votes">\n        <div>\n          ',__p+=0>bill.get("house_ayes")?"\n            &nbsp;\n          ":"\n            "+(null==(__t=bill.get("house_ayes"))?"":__t)+"-"+(null==(__t=bill.get("house_nays"))?"":__t)+"\n          ",__p+="\n        </div>\n      </div>\n    "),__p+='\n    \n    <div class="bill-house-sponsors">\n      ',_.isEmpty(bill.get("house_sponsors"))||(__p+="\n        <h6>House Sponsors</h6>\n        <ul>\n          ",_.each(bill.get("house_sponsors"),function(t){__p+="\n            ",t[3]?(__p+='\n              <li>\n                <a target="_blank" href="'+(null==(__t=t[3])?"":__t)+'">'+(null==(__t=t[0])?"":__t)+"</a>\n                ",t[1]&&(__p+="\n                  ("+(null==(__t=t[1].charAt(0))?"":__t)+")\n                "),__p+="\n              </li>\n            "):__p+="\n              <li>"+(null==(__t=t[0])?"":__t)+"</li>\n            ",__p+="\n          "}),__p+="\n        </ul>\n      "),__p+='\n    </div>\n  </div>\n\n  <div class="bill-senate">\n    ',bill.get("senate_ayes")!==void 0&&(__p+='\n      <div class="bill-senate-votes bill-votes">\n        <div>\n          ',__p+=0>bill.get("senate_ayes")?"\n            &nbsp;\n          ":"\n            "+(null==(__t=bill.get("senate_ayes"))?"":__t)+"-"+(null==(__t=bill.get("senate_nays"))?"":__t)+"\n          ",__p+="\n        </div>\n      </div>\n    "),__p+='\n    \n    <div class="bill-senate-sponsors">\n      ',_.isEmpty(bill.get("senate_sponsors"))||(__p+="\n        <h6>Senate Sponsors</h6>\n        <ul>\n          ",_.each(bill.get("senate_sponsors"),function(t){__p+="\n            ",t[3]?(__p+='\n              <li>\n                <a target="_blank" href="'+(null==(__t=t[3])?"":__t)+'">'+(null==(__t=t[0])?"":__t)+"</a>\n                ",t[1]&&(__p+="\n                  ("+(null==(__t=t[1].charAt(0))?"":__t)+")\n                "),__p+="\n              </li>\n            "):__p+="\n              <li>"+(null==(__t=t[0])?"":__t)+"</li>\n            ",__p+="\n          "}),__p+="\n        </ul>\n      "),__p+='\n    </div>\n  </div>\n  <br class="clear" />\n  \n  ',_.isEmpty(bill.get("categories"))||(__p+='\n    <div class="bill-categories">\n      Categories: \n      <ul>\n        ',_.each(bill.get("categories"),function(t,e,n){__p+='\n          <li>\n            <a href="#'+(null==(__t=t)?"":__t)+'" data-category="'+(null==(__t=t)?"":__t)+'">'+(null==(__t=t)?"":__t)+"</a>",n.length-1>e&&(__p+=","),__p+="\n          </li>\n        "}),__p+="\n      </ul>\n    "),__p+="\n  </div>\n</div>";return __p},this.mpApp["minnpost-legislature-roundup-2013"].templates["js/templates/template-category.html"]=function(obj){obj||(obj={});var __t,__p="";with(_.escape,Array.prototype.join,obj)__p+='\n<a class="all-categories" href="#all-categories"><i class="bs-icon bs-icon-white bs-icon-circle-arrow-left"></i> back</a>\n<h3>\n  ',"undefined"!=typeof image_url&&(__p+='\n    <img class="category-image" src="'+(null==(__t=image_url)?"":__t)+'" /> \n  '),__p+="\n  ","undefined"!=typeof sponsor&&sponsor[2]!==void 0&&(__p+='\n    <img class="category-image" src="'+(null==(__t=sponsor[2])?"":__t)+'" /> \n  '),__p+="\n  "+(null==(__t=category)?"":__t)+"\n  ","undefined"!=typeof sponsor&&sponsor[1]!==void 0&&(__p+="\n    ("+(null==(__t=sponsor[1].charAt(0))?"":__t)+")\n  "),__p+="\n</h3>";return __p},function(t,e,n){function a(t,a){function o(t,a,i,s,l){return function(){var o=t.set();o.push(i).push(s).push(l).mouseover(function(){i.attr("opacity","1.0"),s.attr("opacity","1.0")}).mouseout(function(){i.attr("opacity","0.8"),s.attr("opacity","0.6")}).click(function(){a!==n&&(a.filterCategory(this.data("name").replace("\n","")),e("#bubble-chooser").slideUp("fast"),e("#category-details").slideDown("fast"))})}}var r=650,c=975,p=6,_=60,u=150,d=-50,h=165,g=["156DAC","1571A6","1575A0","15799A","157D94","15828E","158688","158A82","158E7D","159277","159771","159B6B","159F65","15A35F","15A759","15AC54"],m=[],b={Vetoed:"323232",Controversial:"E31C2D"},f={Vetoed:-1,Controversial:-2},v=1;for(var y in t)v=t[y].length>v?t[y].length:v,m.push({name:y,bills:t[y]});m=m.sort(function(t,e){return f[t.name]!==n?0-f[t.name]:f[e.name]!==n?f[e.name]:e.bills.length-t.bills.length});var w=Raphael(document.getElementById("bubble-chart"),c,r);for(var j in m){var A=m[j].bills.length/v,C=_*_*Math.PI,D=_*p*Math.PI,B=A*(C-D)+D,E=Math.sqrt(B/Math.PI),I=g[Math.floor(Math.random()*g.length)];b[m[j].name]!==n&&(I=b[m[j].name]),d+=150,d+E>=c&&(d=100,h+=u);var k=w.circle(Math.random()*(c-E),Math.random()*(r-E),0).data("name",m[j].name).data("spreadX",d).data("spreadY",h-E).data("radius",E).attr("fill",Raphael.rgb(i(I,"R"),i(I,"G"),i(I,"B"))).attr("opacity","0.7").attr("stroke-width",.5).attr("cursor","pointer"),T=Raphael.animation({r:E},1e3,"easeIn");k.animate(T.delay(1e3*Math.random()));var x=w.text(k.attrs.cx,k.attrs.cy).attr("font-size",12).attr("fill","#444").attr("cursor","pointer").data("spreadX",d).data("spreadY",h+20).data("name",m[j].name);x=l(m[j].name,x);var M=a.getCatIcon(m[j].name);M=w.image("https://s3.amazonaws.com/data.minnpost/projects/mn-legislature-roundup-2012/icons/"+M+".png",Math.random()*(c-E),Math.random()*(r-E),.9*E,.9*E).attr("opacity","0.1").attr("cursor","pointer").data("spreadX",d-.5*E+1).data("spreadY",h-1.5*E+1).data("name",m[j].name);var P=Raphael.animation({opacity:"0.6"},1e3,"easeIn");M.animate(P.delay(1e3*Math.random()));var R=o(w,a,k,M,x);R()}s(w)}function i(t,e){switch(t="#"==t.charAt(0)?t.substring(1,7):t,e){case"R":return parseInt(t.substring(0,2),16);case"G":return parseInt(t.substring(2,4),16);case"B":return parseInt(t.substring(4,6),16)}}function s(t){t.forEach(function(t){var e;"circle"===t.type?(e=Raphael.animation({cx:t.data("spreadX"),cy:t.data("spreadY")},1e3,"backOut"),t.animate(e.delay(1e3*Math.random()))):("text"===t.type||"image"===t.type)&&(e=Raphael.animation({x:t.data("spreadX"),y:t.data("spreadY")},1e3,"backOut"),t.animate(e.delay(1e3*Math.random())))})}function l(t,e){for(var n=140,a=t.split(" "),i="",s=0;a.length>s;s++)e.attr("text",i+" "+a[s]),i+=e.getBBox(!0).width>n?"\n"+a[s]:" "+a[s];return e.attr("text",i.substring(1))}var o=Backbone.Model.extend({sessionBegin:function(){return t.options.sessionBegin},sessionEnd:function(){return t.options.sessionEnd},convertDate:function(t){var e=t.replace(/( [0-9]{2}:[0-9]{2}:[0-9]{2}$)/,"").split("-");return _.isArray(e)&&3==e.length?new Date(e[0],e[1]-1,e[2]):new Date},getDays:function(){var t=this.convertDate(this.get("start_date")),e=this.convertDate(this.get("end_date")),n=432e5;return Math.ceil((e.getTime()+1-t.getTime())/n)},getIntervalPercentage:function(){var t=432e5,e=this.sessionBegin(),n=this.sessionEnd(),a=Math.ceil((n.getTime()+1-e.getTime())/t),i=3>this.getDays()?3:this.getDays();return i>a?1:i/a},getStartPercentage:function(){var t=432e5,e=this.sessionBegin(),n=this.sessionEnd(),a=this.convertDate(this.get("start_date")),i=Math.ceil((a.getTime()+1-e.getTime())/t),s=Math.ceil((n.getTime()+1-e.getTime())/t);return a.getTime()<e.getTime()?0:i/s},getSponsorData:function(t,e){var n="representative"==e?"house_sponsors":"senate_sponsors",a=this.get(n);if(_.isArray(a))for(var i in a)if(a[i][0]==t)return a[i]}}),r=Backbone.Collection.extend({model:o,filterCategory:function(t){return this.filter(function(e){if(_.isArray(e.get("categories"))){var n=_.filter(e.get("categories"),function(e){return e==t});return!_.isEmpty(n)}return!1})},filterAuthor:function(t,e){var n="representative"==e?"house_sponsors":"senate_sponsors";return _.isArray(t)||(t=[t]),this.filter(function(e){if(_.isArray(e.get(n))){var a=_.filter(e.get(n),function(e){return-1===_.indexOf(t,e[0])?!1:!0});return!_.isEmpty(a)}return!1})},comparator:function(t){return"pending"==t.get("bill_status")?"zzz":t.get("bill_status")}}),c=Backbone.View.extend({initialize:function(t){_.bindAll(this,"render"),this.model=t.model||new o},render:function(){return t.getTemplate("template-bill",function(t){e(this.el).html(t({bill:this.model}));var n=e(".bill-details-wrapper").height(),a=e("#bills-list-container").height();a>n&&e(".bill-details-wrapper").height(a)},this),this}}),p=Backbone.View.extend({categoryContainer:e("#bill-category-container"),listContainer:e("#bills-list-container"),events:{"click .show-bill":"showBill","submit form#address-chooser-form":"showByAddress"},initialize:function(t){_.bindAll(this,"render","showBill","showFirstBill","activateBill","showByAddress","filterCategory"),this.collection=t.collection||new r,this.fullCollection=new r(this.collection.models),this.billView=new c({el:e("#bill-detail-container")})},render:function(){return t.getTemplate("template-bill-list",function(t){this.listContainer.html(t({bills:this.collection.models}));var n=e(".bills-list ul li").size();n>16&&e(".bills-list").addClass("is-scrolling")},this),this},showBill:function(t){t.preventDefault();var n=e(t.currentTarget);return this.billView.model=this.collection.get(n.attr("data-id")),this.activateBill(n),this.billView.render(),this.activateCategoryLinks(),this},showFirstBill:function(){return this.billView.model=this.collection.at(0),this.activateBill(e('[data-id="'+this.billView.model.cid+'"]')),this.billView.render(),this.activateCategoryLinks(),this},activateCategoryLinks:function(){var t=this;return e(".bill-categories ul a").click(function(n){n.preventDefault(),t.filterCategory(e(this).attr("data-category"))}),t},activateBill:function(t){return e(".show-bill").removeClass("active"),t.addClass("active"),this},showCategory:function(e){return t.getTemplate("template-category",function(t){this.categoryContainer.html(t(e))},this),this},showError:function(t){e('<div class="address-error">'+t+"</div>").hide().prependTo("#address-chooser-form").fadeIn()},removeErrors:function(){e("#address-chooser-form .address-error").fadeOut("fast")},showByAddress:function(t){t.preventDefault();var a=this;e(t.currentTarget);var i=e('input:radio[name="author_type"]:checked').val(),s=e("input#address-chooser-address").val(),l=[43.499356,-97.239209,49.384358,-89.489226];this.removeErrors(),e.getJSON("http://open.mapquestapi.com/nominatim/v1/search?format=json&json_callback=?&countrycodes=us&limit=1&q="+encodeURI(s),function(t){if(t=t[0],t===n)a.showError("We were unable turn your search terms, "+s+", into a geographical location.  Please be more specific, such as including ZIP code.");else if(t.lat<l[0]||t.lat>l[2]||t.lon<l[1]||t.lon>l[3])a.showError("Sorry, but what you are looking for is outside of Minnesota.");else{var o="49c5c72c157d4b37892ddb52c63d06be",r="http://openstates.org/api/v1/legislators/geo/?long="+encodeURI(t.lon)+"&lat="+encodeURI(t.lat)+"&apikey="+encodeURI(o)+"&callback=?";e.getJSON(r,function(t){var n,s=[],l="representative"==i?"lower":"upper";for(n in t)t[n].active&&"state"==t[n].level&&t[n].chamber==l&&s.push(t[n].full_name);if(_.isEmpty(s))a.showError("We could not find a representative for that address.");else{var o=s[s.length-1],r=a.filterAuthor(o,i,!0);_.isEmpty(r)?a.showError("There were no bills found that were sponsored by your legislator(s): <em>"+o+"</em>.  This could be an issue with the data quality and may not accurately reflect the activities of these legislator(s)."):(e("#address-chooser").slideUp("fast"),e("#category-details").slideDown("fast"))}})}})},filterAuthor:function(t,e){var n=this.fullCollection.filterAuthor(t,e);return _.isEmpty(n)||(this.collection.reset(n),this.showCategory({category:t,sponsor:this.collection.at(0).getSponsorData(t,e)}),this.render(),this.showFirstBill()),n},filterCategory:function(t){var e=this.fullCollection.filterCategory(t);if(_.isEmpty(e));else{this.collection.reset(e);var n="https://s3.amazonaws.com/data.minnpost/projects/mn-legislature-roundup-2012/icons/"+this.getCatIcon(t)+".png";this.showCategory({category:t,image_url:n}),this.render(),this.showFirstBill()}},getCatIcon:function(t){return icons={Government:"noun_project_1761","Energy and Technology":"noun_project_2075","Housing and Property":"noun_project_1439","Campaign Finance and Election Issues":"noun_project_287","Reproductive Issues":"noun_project_626","Environment and Recreation":"noun_project_479","Health and Science":"noun_project_1868",Military:"noun_project_1697","Welfare and poverty":"noun_project_620","Budget, Spending and Taxes":"noun_project_925",Insurance:"noun_project_1675","Business and Economy":"noun_project_1640",Education:"noun_project_1051",Immigration:"noun_project_31","Agriculture and Food":"noun_project_741","Arts and Humanities":"noun_project_1554",Guns:"noun_project_138","Gambling and Gaming":"noun_project_1740","Crime and Drugs":"noun_project_2039","Social Issues":"noun_project_288",Vetoed:"noun_project_558",Controversial:"noun_project_1635",Legal:"noun_project_1004",Transportation:"noun_project_97"},icons[t]!==n?icons[t]:""}});e('<span class="loading-temp">Loading...</span>').hide().prependTo(e("#application-nav").parent()).fadeIn(),billsProcess=function(n){var i,s={};for(i in n){var l;if(_.isArray(n[i].categories))for(l in n[i].categories)s[n[i].categories[l]]=s[n[i].categories[l]]||[],s[n[i].categories[l]].push(i)}var c=new r;for(i in n)n[i].bill=i,c.add(new o(n[i]));var u=new p({el:t.options.el,collection:c});e(".loading-temp").fadeOut(),e("#application-nav, #tab-container").show(),a(s,u),e(".all-categories").on("click",t.options.el,function(t){t.preventDefault(),e(".by-category").hasClass("tab-active")?e("#bubble-chooser").slideDown("fast"):e("#address-chooser").slideDown("fast"),e("#category-details").slideUp("fast")}),e(".by-category").click(function(t){t.preventDefault(),e(".by-category").hasClass("tab-active")||(e("#address-chooser").fadeOut("fast"),e("#application-nav li, #application-nav a").toggleClass("tab-active")),e("#bubble-chooser").fadeIn("fast"),e("#category-details").hide()}),e(".by-address").click(function(t){t.preventDefault(),e(".by-address").hasClass("tab-active")||(e("#bubble-chooser").fadeOut("fast"),e("#application-nav li, #application-nav a").toggleClass("tab-active")),e("#address-chooser").fadeIn("fast"),e("#category-details").hide()});var d="Enter your address";e("#address-chooser-address").val(d).addClass("showing-label").focus(function(){e(this).val()==d&&e(this).val("").removeClass("showing-label")}).blur(function(){(""===e(this).val()||e(this).val()==d)&&e(this).val(d).addClass("showing-label")})},t.start=function(){t.getData("data/bills").done(function(t){billsProcess(t)})}}(mpApp["minnpost-legislature-roundup-2013"],jQuery);